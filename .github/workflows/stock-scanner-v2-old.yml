name: Stock Scanner V2 - Old (Telegram)

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false  # don't cancel long scans

on:
  schedule:
    - cron: '*/5 * * * 1-5'   # every 5 min, weekdays (UTC)
  workflow_dispatch:
    inputs:
      RUN_AFTER_HOURS:
        type: boolean
        description: 'Allow running outside US market hours?'
        default: false
      ALWAYS_NOTIFY:
        type: boolean
        description: 'Send a summary even if there are no NEW alerts?'
        default: true
      PING_ON_START:
        type: boolean
        description: 'Send a startup ping?'
        default: false
      PING_ON_END:
        type: boolean
        description: 'Send a completion ping?'
        default: false
      TICKERS:
        type: string
        description: 'Optional override list (comma/space/semicolon/pipe separated)'
        default: ''
      PROFILE:
        type: choice
        description: 'Preset'
        options: ['balanced (core)', 'conservative (strict)', 'aggressive (loose)']
        default: 'balanced (core)'
      DEBUG_DETAIL:
        type: choice
        description: 'Include per-ticker gate flags & bottlenecks in the output?'
        options: ['false', 'true']
        default: 'false'
      ADVANCED_JSON:
        type: string
        description: 'Optional overrides as JSON'
        default: ''

jobs:
  scan:
    runs-on: ubuntu-latest
    timeout-minutes: 12

    env:
      TZ: America/New_York
      CADENCE_MIN: '55'
      TOLERANCE_MIN: '5'
      # For schedule: prefer repo/org variable; fall back to secret; default false.
      # For manual dispatch: use the input.
      RUN_AFTER_HOURS: ${{ github.event_name == 'workflow_dispatch'
        && (inputs.RUN_AFTER_HOURS && 'true' || 'false')
        || (vars.RUN_AFTER_HOURS || secrets.RUN_AFTER_HOURS || 'false') }}

    steps:
      # ---- Gate FIRST; everything else depends on it ----
      - name: Gate cadence (sets outputs ok=yes|no)
        id: gate
        shell: bash
        run: |
          ok=yes
          reason=""
      
          dow=$(TZ=America/New_York date +%u)
          hh=$(TZ=America/New_York date +%H)
          mm=$(TZ=America/New_York date +%M)
          mins=$((10#$hh*60 + 10#$mm))
      
          open=$((9*60 + 30))
          close=$((16*60))
      
          cad=${CADENCE_MIN:-55}
          tol=${TOLERANCE_MIN:-5}
          run_after_hours="${RUN_AFTER_HOURS}"
          run_after_hours="${run_after_hours,,}"   # lowercase normalize
      
          # Are we inside regular trading hours?
          in_rth=no
          if [ "$dow" -ge 1 ] && [ "$dow" -le 5 ] && [ $mins -ge $open ] && [ $mins -lt $close ]; then
            in_rth=yes
          fi
      
          # 1) Block weekends always
          # if [ "$dow" -ge 6 ]; then
          #   ok=no; reason="weekend"
          # fi
          
          # 1) Block weekends unless manual run
          if [ "$dow" -ge 6 ] && [ "${{ github.event_name }}" != "workflow_dispatch" ]; then
            ok=no; reason="weekend"
          fi

      
          # 2) If outside RTH and after-hours not allowed, block
          if [ "$ok" = "yes" ] && [ "$in_rth" = "no" ] && [ "$run_after_hours" != "true" ]; then
            ok=no; reason="outside RTH"
          fi
      
          # # 3) Cadence gate applies in BOTH RTH and (if allowed) after-hours
          # if [ "$ok" = "yes" ]; then
          #   delta=$(( mins - open ))                              # anchor cadence to 09:30 ET
          #   rem=$(( ( (delta % cad) + cad ) % cad ))             # safe modulo
          #   if [ $rem -le $tol ] || [ $rem -ge $((cad - tol)) ]; then
          #     : # on cadence
          #   else
          #     ok=no; reason="off cadence (rem=$rem tol=$tol)"
          #   fi
          # fi

          # 3) Cadence gate applies in BOTH RTH and (if allowed) after-hours
          # But skip cadence check for manual dispatches
          if [ "$ok" = "yes" ]; then
            if [ "${{ github.event_name }}" != "workflow_dispatch" ]; then
              delta=$(( mins - open ))                              # anchor cadence to 09:30 ET
              rem=$(( ( (delta % cad) + cad ) % cad ))             # safe modulo
              if [ $rem -le $tol ] || [ $rem -ge $((cad - tol)) ]; then
                : # on cadence
              else
                ok=no; reason="off cadence (rem=$rem tol=$tol)"
              fi
            fi
          fi

      
          HM=$(TZ=America/New_York date +'%H:%M')
          {
            echo "now=$HM"
            echo "ok=$ok"
            echo "reason=$reason"
            echo "in_rth=$in_rth"
            echo "rem=${rem:-na}"
          } >> "$GITHUB_OUTPUT"
          echo "Gate: ok=$ok in_rth=$in_rth rem=${rem:-na} cad=$cad tol=$tol reason='$reason' NY=$HM"


      # ---- Heavy steps guarded by the gate ----
      - name: Checkout
        if: steps.gate.outputs.ok == 'yes'
        uses: actions/checkout@v4

      - name: Set up Python
        if: steps.gate.outputs.ok == 'yes'
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip
        if: steps.gate.outputs.ok == 'yes'
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: ${{ runner.os }}-pip-

      - name: Install deps
        if: steps.gate.outputs.ok == 'yes'
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install pandas numpy yfinance requests certifi
          fi

      - name: Compute week key
        if: steps.gate.outputs.ok == 'yes'
        run: echo "WEEK_KEY=$(TZ=America/New_York date +%G-%V)" >> $GITHUB_ENV

      - name: Restore scanner cache
        if: steps.gate.outputs.ok == 'yes'
        id: scancache
        uses: actions/cache/restore@v4
        with:
          path: .scanner_cache
          key: scanner-cache-${{ runner.os }}-${{ env.WEEK_KEY }}
          restore-keys: |
            scanner-cache-${{ runner.os }}-

      - name: Expand PROFILE/ADVANCED_JSON â†’ env
        if: steps.gate.outputs.ok == 'yes'
        shell: bash
        env:
          PROFILE: ${{ inputs.PROFILE }}
          ADVANCED_JSON: ${{ inputs.ADVANCED_JSON }}
          DEBUG_DETAIL: ${{ inputs.DEBUG_DETAIL }}
        run: |
          python - <<'PY'
          import os, json, sys
          profile = (os.environ.get("PROFILE","balanced (core)") or "balanced (core)").strip().lower()
          presets = {
            "balanced (core)": {"ENABLE_4H": True, "ENFORCE_4H_ANCHORED_VWAP": True,
              "REGIME_SYMBOL": "SPY", "REGIME_DOWNGRADE_TO_WATCH": True,
              "MIN_20D_DOLLAR_VOL": 5_000_000, "VOL_UP_LOOKBACK": 10, "VOL_UP_MULT": 1.2,
              "BUY_LOWER_BAND_ATR_MULT": 0.5, "BUY_UPPER_BAND_ATR_MULT": 0.25,
              "MIN_RR": 1.5, "DIV_MIN": 2},
            "conservative (strict)": {"ENABLE_4H": True, "ENFORCE_4H_ANCHORED_VWAP": True,
              "REGIME_SYMBOL": "SPY", "REGIME_DOWNGRADE_TO_WATCH": True,
              "MIN_20D_DOLLAR_VOL": 10_000_000, "VOL_UP_LOOKBACK": 12, "VOL_UP_MULT": 1.4,
              "BUY_LOWER_BAND_ATR_MULT": 0.75, "BUY_UPPER_BAND_ATR_MULT": 0.5,
              "MIN_RR": 2.0, "DIV_MIN": 3},
            "aggressive (loose)": {"ENABLE_4H": True, "ENFORCE_4H_ANCHORED_VWAP": False,
              "REGIME_SYMBOL": "SPY", "REGIME_DOWNGRADE_TO_WATCH": False,
              "MIN_20D_DOLLAR_VOL": 2_000_000, "VOL_UP_LOOKBACK": 8, "VOL_UP_MULT": 1.0,
              "BUY_LOWER_BAND_ATR_MULT": 0.4, "BUY_UPPER_BAND_ATR_MULT": 0.2,
              "MIN_RR": 1.2, "DIV_MIN": 1}
          }
          cfg = dict(presets.get(profile, presets["balanced (core)"]))
          raw = (os.environ.get("ADVANCED_JSON","") or "").strip()
          if raw:
            try:
              user = json.loads(raw)
              if not isinstance(user, dict): raise ValueError("must be a JSON object")
              cfg.update(user)
            except Exception as e:
              print("Invalid ADVANCED_JSON:", e)
              sys.exit(1)
          mapping = {"ENABLE_4H":"IDE_ENABLE_4H","ENFORCE_4H_ANCHORED_VWAP":"ENFORCE_4H_ANCHORED_VWAP",
                     "REGIME_SYMBOL":"REGIME_SYMBOL","REGIME_DOWNGRADE_TO_WATCH":"REGIME_DOWNGRADE_TO_WATCH",
                     "MIN_20D_DOLLAR_VOL":"MIN_20D_DOLLAR_VOL","VOL_UP_LOOKBACK":"VOL_UP_LOOKBACK",
                     "VOL_UP_MULT":"VOL_UP_MULT","BUY_LOWER_BAND_ATR_MULT":"BUY_LOWER_BAND_ATR_MULT",
                     "BUY_UPPER_BAND_ATR_MULT":"BUY_UPPER_BAND_ATR_MULT","MIN_RR":"MIN_RR","DIV_MIN":"DIV_MIN"}
          def as_bool(v): return "true" if str(v).lower() in ("1","true","yes","on","y") else "false"
          with open(os.environ["GITHUB_ENV"], "a", encoding="utf-8") as f:
            for k, dst in mapping.items():
              if k in cfg:
                v = cfg[k]
                if isinstance(v, bool): v = as_bool(v)
                f.write(f"{dst}={v}\n")
            f.write(f"DEBUG_DETAIL={(os.environ.get('DEBUG_DETAIL','false').lower())}\n")
          print("Effective profile:", profile)
          print("Effective config:", json.dumps(cfg, separators=(',',':')))
          PY

      - name: Run scanner
        if: steps.gate.outputs.ok == 'yes'
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          TELEGRAM_CHAT_IDS: ${{ secrets.TELEGRAM_CHAT_IDS }}
          MARKET_ONLY: ${{ env.RUN_AFTER_HOURS == 'true' && 'false' || 'true' }}
          ALWAYS_NOTIFY: ${{ github.event_name == 'workflow_dispatch'
            && (inputs.ALWAYS_NOTIFY && 'true' || 'false') || 'true' }}
          TELEGRAM_PING_ON_START: ${{ inputs.PING_ON_START && 'true' || 'false' }}
          TELEGRAM_PING_ON_END: ${{ inputs.PING_ON_END && 'true' || 'false' }}
          TICKERS: ${{ inputs.TICKERS }}
          CACHE_DIR: .scanner_cache
          #NOTIFY_PREFIX: "[Enhanced Version V2-Old] "
          NOTIFY_PREFIX: ${{ format('[ Version V2-Old _ {0} Mode ] ', inputs.PROFILE == 'balanced (core)' && 'Balanced' || inputs.PROFILE == 'conservative (strict)' && 'Conservative' || 'Aggressive') }}

        run: |
          PYTHONUNBUFFERED=1 python scanner_dual_tf_vp_spyder_telegram_loop_dip5.py

      - name: Upload CSV + state as artifact
        if: steps.gate.outputs.ok == 'yes' || failure()
        uses: actions/upload-artifact@v4
        with:
          name: scanner-output
          path: |
            scanner_dual_tf_vp_dip4.csv
            .scanner_cache/alerts_dip4_seen.json

      - name: Save scanner cache
        if: steps.gate.outputs.ok == 'yes' && steps.scancache.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: .scanner_cache
          key: scanner-cache-${{ runner.os }}-${{ env.WEEK_KEY }}
