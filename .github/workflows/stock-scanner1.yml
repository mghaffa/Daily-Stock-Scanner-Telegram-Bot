name: Stock Scanner V2 (Telegram)

on:
  workflow_dispatch:
    inputs:
      RUN_AFTER_HOURS:
        type: boolean
        description: "Allow running outside US market hours?"
        default: false
      ALWAYS_NOTIFY:
        type: boolean
        description: "Send a summary even if there are no NEW alerts?"
        default: false
      PING_ON_START:
        type: boolean
        description: "Send a startup ping?"
        default: false
      PING_ON_END:
        type: boolean
        description: "Send a completion ping?"
        default: false

      # --- Universe / overrides ---
      TICKERS:
        type: string
        description: "Optional override list (comma/space/semicolon/pipe separated)"
        default: ""

      # --- Regime & 4H gating ---
      ENABLE_4H:
        type: boolean
        description: "Process 4H timeframe (used for entry timing/confidence)"
        default: true
      USE_AVWAP_4W_4H:
        type: boolean
        description: "Require 4H Close ≥ 4-week Anchored VWAP for entries"
        default: true
      REGIME_TICKER:
        type: string
        description: "Market regime symbol"
        default: "SPY"
      REGIME_STRICT:
        type: boolean
        description: "Downgrade to WATCH if regime is weak"
        default: true

      # --- Liquidity / volume confirmation ---
      MIN_DOLLAR_VOL:
        type: string
        description: "Min 20d $ volume (e.g. 10000000 = $10M)"
        default: "10000000"
      VOL_UP_LOOKBACK:
        type: string
        description: "Lookback bars for up-day volume confirm"
        default: "10"
      VOL_UP_MULT:
        type: string
        description: "Up-day must be ≥ this × 20d avg volume"
        default: "1.2"

      # --- Sweet-spot band near EMA50 ---
      SWEET_ATR_LOW:
        type: string
        description: "Lower band: EMA50 - (this × ATR)"
        default: "0.5"
      SWEET_ATR_HIGH:
        type: string
        description: "Upper band: EMA50 + (this × ATR)"
        default: "0.25"

      # --- Quality gates ---
      RR_MIN:
        type: string
        description: "Minimum Reward/Risk"
        default: "1.5"
      DIV_MIN:
        type: string
        description: "Min bullish divergence count"
        default: "2"

  # Every 50 minutes on weekdays (UTC). Step below filters to US RTH by default.
  schedule:
    - cron: "*/50 * * * 1-5"

concurrency:
  group: stock-scanner
  cancel-in-progress: false

jobs:
  scan:
    runs-on: ubuntu-latest
    timeout-minutes: 12
    env:
      TZ: America/New_York
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: ${{ runner.os }}-pip-

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install pandas numpy yfinance requests certifi urllib3
          fi

      # Default: skip runs outside US RTH unless user allows after-hours
      - name: Skip outside US RTH (unless overridden)
        run: |
          if [ "${{ inputs.RUN_AFTER_HOURS }}" != "true" ]; then
            now=$(TZ=America/New_York date +%H%M)
            dow=$(TZ=America/New_York date +%u)
            if [ "$dow" -ge 6 ] || [ "$now" -lt 0930 ] || [ "$now" -gt 1600 ]; then
              echo "Outside US RTH — exiting."
              exit 0
            fi
          fi

      - name: Show inputs (debug)
        run: |
          echo "TICKERS='${{ inputs.TICKERS }}'"
          echo "ENABLE_4H=${{ inputs.ENABLE_4H }}"
          echo "USE_AVWAP_4W_4H=${{ inputs.USE_AVWAP_4W_4H }}"
          echo "REGIME_TICKER='${{ inputs.REGIME_TICKER }}' REGIME_STRICT=${{ inputs.REGIME_STRICT }}"
          echo "MIN_DOLLAR_VOL=${{ inputs.MIN_DOLLAR_VOL }} VOL_UP_LOOKBACK=${{ inputs.VOL_UP_LOOKBACK }} VOL_UP_MULT=${{ inputs.VOL_UP_MULT }}"
          echo "SWEET_ATR_LOW=${{ inputs.SWEET_ATR_LOW }} SWEET_ATR_HIGH=${{ inputs.SWEET_ATR_HIGH }}"
          echo "RR_MIN=${{ inputs.RR_MIN }} DIV_MIN=${{ inputs.DIV_MIN }}"

      - name: Run scanner
        env:
          # --- Telegram secrets ---
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID:  ${{ secrets.TELEGRAM_CHAT_ID }}
          TELEGRAM_CHAT_IDS: ${{ secrets.TELEGRAM_CHAT_IDS }}

          # --- Behavior toggles ---
          MARKET_ONLY: ${{ inputs.RUN_AFTER_HOURS && 'false' || 'true' }}
          ALWAYS_NOTIFY: ${{ inputs.ALWAYS_NOTIFY && 'true' || 'false' }}
          TELEGRAM_PING_ON_START: ${{ inputs.PING_ON_START && 'true' || 'false' }}
          TELEGRAM_PING_ON_END:   ${{ inputs.PING_ON_END && 'true' || 'false' }}

          # --- Universe override ---
          TICKERS: ${{ inputs.TICKERS }}

          # --- Regime & 4H gate ---
          IDE_ENABLE_4H:     ${{ inputs.ENABLE_4H && 'true' || 'false' }}
          USE_AVWAP_4W_4H:   ${{ inputs.USE_AVWAP_4W_4H && 'true' || 'false' }}
          REGIME_TICKER:     ${{ inputs.REGIME_TICKER }}
          REGIME_STRICT:     ${{ inputs.REGIME_STRICT && 'true' || 'false' }}

          # --- Liquidity / volume confirmation ---
          MIN_DOLLAR_VOL:    ${{ inputs.MIN_DOLLAR_VOL }}
          VOL_UP_LOOKBACK:   ${{ inputs.VOL_UP_LOOKBACK }}
          VOL_UP_MULT:       ${{ inputs.VOL_UP_MULT }}

          # --- Sweet-spot and quality gates ---
          SWEET_ATR_LOW:     ${{ inputs.SWEET_ATR_LOW }}
          SWEET_ATR_HIGH:    ${{ inputs.SWEET_ATR_HIGH }}
          RR_MIN:            ${{ inputs.RR_MIN }}
          DIV_MIN:           ${{ inputs.DIV_MIN }}
        run: |
          # Unbuffered so logs show ticker parsing & gates
          PYTHONUNBUFFERED=1 python scanner_dual_tf_vp_spyder_telegram_loop_dip4.py

      - name: Upload CSV + state as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: scanner-output
          path: |
            scanner_dual_tf_vp_dip4.csv
            alerts_dip4_seen.json
