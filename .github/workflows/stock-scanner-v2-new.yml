name: Stock Scanner V2 (Telegram)

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

on:
  schedule:
    - cron: '*/5 * * * 1-5'   # every 5 min, weekdays (UTC)
  workflow_dispatch:
    inputs:
      RUN_AFTER_HOURS:
        type: boolean
        description: 'Allow running outside US market hours?'
        default: false
      ALWAYS_NOTIFY:
        type: boolean
        description: 'Send a summary even if there are no NEW alerts?'
        default: true
      PING_ON_START:
        type: boolean
        description: 'Send a startup ping?'
        default: false
      PING_ON_END:
        type: boolean
        description: 'Send a completion ping?'
        default: false
      TICKERS:
        type: string
        description: 'Optional override list (comma/space/semicolon/pipe separated)'
        default: ''
      PROFILE:
        type: choice
        description: 'Preset'
        options: ['balanced (core)', 'conservative (strict)', 'aggressive (loose)']
        default: 'balanced (core)'
      DEBUG_DETAIL:
        type: choice
        description: 'Include per-ticker gate flags & bottlenecks in the output?'
        options: ['false', 'true']
        default: 'false'
      ADVANCED_JSON:
        type: string
        description: 'Optional overrides as JSON'
        default: ''

jobs:
  scan:
    runs-on: ubuntu-latest
    timeout-minutes: 12

    env:
      TZ: America/New_York
      CADENCE_MIN: '55'     # strict minimum minutes between successful runs
      TOLERANCE_MIN: '4'    # small modulo window around cadence tick
      RUN_AFTER_HOURS_DEFAULT: ${{ vars.RUN_AFTER_HOURS || 'false' }}

    steps:
      # Expose context to env so we can read safely in bash
      - name: Expose context to env
        run: |
          echo "EVENT_IS_DISPATCH=${{ github.event_name == 'workflow_dispatch' }}" >> "$GITHUB_ENV"
          echo "INPUT_RUN_AFTER_HOURS=${{ inputs.RUN_AFTER_HOURS }}" >> "$GITHUB_ENV"
          echo "INPUT_ALWAYS_NOTIFY=${{ inputs.ALWAYS_NOTIFY }}" >> "$GITHUB_ENV"
          echo "INPUT_PING_ON_START=${{ inputs.PING_ON_START }}" >> "$GITHUB_ENV"
          echo "INPUT_PING_ON_END=${{ inputs.PING_ON_END }}" >> "$GITHUB_ENV"
          echo "INPUT_TICKERS=${{ inputs.TICKERS }}" >> "$GITHUB_ENV"
          echo "INPUT_PROFILE=${{ inputs.PROFILE }}" >> "$GITHUB_ENV"
          echo "INPUT_DEBUG_DETAIL=${{ inputs.DEBUG_DETAIL }}" >> "$GITHUB_ENV"
          echo "INPUT_ADVANCED_JSON=${{ inputs.ADVANCED_JSON }}" >> "$GITHUB_ENV"

      # Keep a tiny cache just for cadence timestamp
      - name: Restore cadence cache
        id: cadcache
        uses: actions/cache/restore@v4
        with:
          path: .cadence_cache
          key: cadence-${{ runner.os }}-v1
          restore-keys: |
            cadence-${{ runner.os }}-v1-
            cadence-${{ runner.os }}-

      - name: Gate cadence (sets outputs ok=yes|no)
        id: gate
        shell: bash
        run: |
          set -euo pipefail
          ok=yes
          reason=""

          # Effective after-hours flag: manual input (if dispatch) overrides repo/org default
          run_after_hours="${INPUT_RUN_AFTER_HOURS:-}"
          if [ "${EVENT_IS_DISPATCH}" != "true" ] || [ -z "${run_after_hours}" ]; then
            run_after_hours="${RUN_AFTER_HOURS_DEFAULT}"
          fi
          run_after_hours="${run_after_hours,,}"

          # Current NY time
          dow=$(TZ=America/New_York date +%u)   # 1..7 (Mon..Sun)
          hh=$(TZ=America/New_York date +%H)
          mm=$(TZ=America/New_York date +%M)
          mins=$((10#$hh*60 + 10#$mm))

          open=$((9*60 + 30))   # 09:30
          close=$((16*60))      # 16:00

          cad=${CADENCE_MIN:-55}
          tol=${TOLERANCE_MIN:-4}

          # Inside RTH?
          in_rth=no
          if [ "$dow" -ge 1 ] && [ "$dow" -le 5 ] && [ $mins -ge $open ] && [ $mins -lt $close ]; then
            in_rth=yes
          fi

          # 1) Block weekends
          if [ "$dow" -ge 6 ]; then
            ok=no; reason="weekend"
          fi

          # 2) Outside RTH and after-hours not allowed
          if [ "$ok" = "yes" ] && [ "$in_rth" = "no" ] && [ "$run_after_hours" != "true" ]; then
            ok=no; reason="outside RTH"
          fi

          # 3) Modulo cadence gate (anchored to 09:30 ET)
          if [ "$ok" = "yes" ]; then
            delta=$(( mins - open ))
            rem=$(( ( (delta % cad) + cad ) % cad ))
            if [ $rem -le $tol ] || [ $rem -ge $((cad - tol)) ]; then
              : # on cadence
            else
              ok=no; reason="off cadence (rem=$rem tol=$tol)"
            fi
          fi

          # 4) Strict minimum interval since last success (>= CADENCE_MIN)
          mkdir -p .cadence_cache
          last_path=".cadence_cache/last_run_epoch.txt"
          now_epoch=$(date -u +%s)
          if [ -f "$last_path" ]; then
            last_epoch=$(cat "$last_path" 2>/dev/null || echo 0)
          else
            last_epoch=0
          fi
          if [ "$ok" = "yes" ] && [ "$last_epoch" -gt 0 ]; then
            elapsed=$(( (now_epoch - last_epoch) / 60 ))
            if [ $elapsed -lt $cad ]; then
              ok=no; reason="interval gate: elapsed=${elapsed}min < cad=${cad}min"
            fi
          fi

          HM=$(TZ=America/New_York date +'%H:%M')
          {
            echo "now=$HM"
            echo "ok=$ok"
            echo "reason=$reason"
            echo "in_rth=$in_rth"
            echo "rem=${rem:-na}"
            echo "run_after_hours=$run_after_hours"
          } >> "$GITHUB_OUTPUT"
          echo "Gate: ok=$ok in_rth=$in_rth rem=${rem:-na} cad=$cad tol=$tol AH=$run_after_hours reason='${reason}' NY=$HM"

      - name: Skip (off cadence / outside hours)
        if: ${{ steps.gate.outputs.ok != 'yes' }}
        run: echo "Skipping: ${{ steps.gate.outputs.reason }} @ ${{ steps.gate.outputs.now }} NY"

      # Heavy steps only when gate passes
      - name: Checkout
        if: ${{ steps.gate.outputs.ok == 'yes' }}
        uses: actions/checkout@v4

      - name: Set up Python
        if: ${{ steps.gate.outputs.ok == 'yes' }}
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip
        if: ${{ steps.gate.outputs.ok == 'yes' }}
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: ${{ runner.os }}-pip-

      - name: Install deps
        if: ${{ steps.gate.outputs.ok == 'yes' }}
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install pandas numpy yfinance requests certifi
          fi

      - name: Compute week key
        if: ${{ steps.gate.outputs.ok == 'yes' }}
        run: echo "WEEK_KEY=$(TZ=America/New_York date +%G-%V)" >> $GITHUB_ENV

      - name: Restore scanner cache
        if: ${{ steps.gate.outputs.ok == 'yes' }}
        id: scancache
        uses: actions/cache/restore@v4
        with:
          path: .scanner_cache
          key: scanner-cache-${{ runner.os }}-${{ env.WEEK_KEY }}
          restore-keys: |
            scanner-cache-${{ runner.os }}-

      - name: Expand PROFILE/ADVANCED_JSON â†’ env
        if: ${{ steps.gate.outputs.ok == 'yes' }}
        shell: bash
        env:
          PROFILE: ${{ env.INPUT_PROFILE }}
          ADVANCED_JSON: ${{ env.INPUT_ADVANCED_JSON }}
          DEBUG_DETAIL: ${{ env.INPUT_DEBUG_DETAIL }}
        run: |
          python - <<'PY'
          import os, json, sys
          profile = (os.environ.get("PROFILE","balanced (core)") or "balanced (core)").strip().lower()
          presets = {
            "balanced (core)": {"ENABLE_4H": True, "ENFORCE_4H_ANCHORED_VWAP": True,
              "REGIME_SYMBOL": "SPY", "REGIME_DOWNGRADE_TO_WATCH": True,
              "MIN_20D_DOLLAR_VOL": 5_000_000, "VOL_UP_LOOKBACK": 10, "VOL_UP_MULT": 1.2,
              "BUY_LOWER_BAND_ATR_MULT": 0.5, "BUY_UPPER_BAND_ATR_MULT": 0.25,
              "MIN_RR": 1.5, "DIV_MIN": 2},
            "conservative (strict)": {"ENABLE_4H": True, "ENFORCE_4H_ANCHORED_VWAP": True,
              "REGIME_SYMBOL": "SPY", "REGIME_DOWNGRADE_TO_WATCH": True,
              "MIN_20D_DOLLAR_VOL": 10_000_000, "VOL_UP_LOOKBACK": 12, "VOL_UP_MULT": 1.4,
              "BUY_LOWER_BAND_ATR_MULT": 0.75, "BUY_UPPER_BAND_ATR_MULT": 0.5,
              "MIN_RR": 2.0, "DIV_MIN": 3},
            "aggressive (loose)": {"ENABLE_4H": True, "ENFORCE_4H_ANCHORED_VWAP": False,
              "REGIME_SYMBOL": "SPY", "REGIME_DOWNGRADE_TO_WATCH": False,
              "MIN_20D_DOLLAR_VOL": 2_000_000, "VOL_UP_LOOKBACK": 8, "VOL_UP_MULT": 1.0,
              "BUY_LOWER_BAND_ATR_MULT": 0.4, "BUY_UPPER_BAND_ATR_MULT": 0.2,
              "MIN_RR": 1.2, "DIV_MIN": 1}
          }
          cfg = dict(presets.get(profile, presets["balanced (core)"]))

          raw = (os.environ.get("ADVANCED_JSON","") or "").strip()
          if raw:
            try:
              user = json.loads(raw)
              if not isinstance(user, dict): raise ValueError("must be a JSON object")
              cfg.update(user)
            except Exception as e:
              print("Invalid ADVANCED_JSON:", e)
              sys.exit(1)

          mapping = {"ENABLE_4H":"IDE_ENABLE_4H","ENFORCE_4H_ANCHORED_VWAP":"ENFORCE_4H_ANCHORED_VWAP",
                     "REGIME_SYMBOL":"REGIME_SYMBOL","REGIME_DOWNGRADE_TO_WATCH":"REGIME_DOWNGRADE_TO_WATCH",
                     "MIN_20D_DOLLAR_VOL":"MIN_20D_DOLLAR_VOL","VOL_UP_LOOKBACK":"VOL_UP_LOOKBACK",
                     "VOL_UP_MULT":"VOL_UP_MULT","BUY_LOWER_BAND_ATR_MULT":"BUY_LOWER_BAND_ATR_MULT",
                     "BUY_UPPER_BAND_ATR_MULT":"BUY_UPPER_BAND_ATR_MULT","MIN_RR":"MIN_RR","DIV_MIN":"DIV_MIN"}
          def as_bool(v): return "true" if str(v).lower() in ("1","true","yes","on","y") else "false"
          with open(os.environ["GITHUB_ENV"], "a", encoding="utf-8") as f:
            for k, dst in mapping.items():
              if k in cfg:
                v = cfg[k]
                if isinstance(v, bool):
                  v = as_bool(v)
                f.write(f"{dst}={v}\n")
            f.write(f"DEBUG_DETAIL={(os.environ.get('DEBUG_DETAIL','false').lower())}\n")
          print("Effective profile:", profile)
          print("Effective config:", json.dumps(cfg, separators=(',',':')))
          PY

      - name: Derive runtime env flags
        if: ${{ steps.gate.outputs.ok == 'yes' }}
        env:
          RUN_AH: ${{ steps.gate.outputs.run_after_hours }}
          EVENT_IS_DISPATCH: ${{ github.event_name == 'workflow_dispatch' }}
          INPUT_ALWAYS_NOTIFY: ${{ env.INPUT_ALWAYS_NOTIFY }}
          INPUT_PING_ON_START: ${{ env.INPUT_PING_ON_START }}
          INPUT_PING_ON_END: ${{ env.INPUT_PING_ON_END }}
          INPUT_TICKERS: ${{ env.INPUT_TICKERS }}
        run: |
          if [ "${RUN_AH}" = "true" ]; then
            echo "MARKET_ONLY=false" >> "$GITHUB_ENV"
          else
            echo "MARKET_ONLY=true" >> "$GITHUB_ENV"
          fi
          if [ "${EVENT_IS_DISPATCH}" = "true" ]; then
            if [ "${INPUT_ALWAYS_NOTIFY}" = "true" ]; then
              echo "ALWAYS_NOTIFY=true" >> "$GITHUB_ENV"
            else
              echo "ALWAYS_NOTIFY=false" >> "$GITHUB_ENV"
            fi
          else
            echo "ALWAYS_NOTIFY=true" >> "$GITHUB_ENV"
          fi
          echo "TELEGRAM_PING_ON_START=${INPUT_PING_ON_START:-false}" >> "$GITHUB_ENV"
          echo "TELEGRAM_PING_ON_END=${INPUT_PING_ON_END:-false}" >> "$GITHUB_ENV"
          echo "TICKERS=${INPUT_TICKERS}" >> "$GITHUB_ENV"

      - name: Run scanner
        if: ${{ steps.gate.outputs.ok == 'yes' }}
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          TELEGRAM_CHAT_IDS: ${{ secrets.TELEGRAM_CHAT_IDS }}
          MARKET_ONLY: ${{ env.MARKET_ONLY }}
          ALWAYS_NOTIFY: ${{ env.ALWAYS_NOTIFY }}
          TELEGRAM_PING_ON_START: ${{ env.TELEGRAM_PING_ON_START }}
          TELEGRAM_PING_ON_END: ${{ env.TELEGRAM_PING_ON_END }}
          TICKERS: ${{ env.TICKERS }}
          CACHE_DIR: .scanner_cache
          NOTIFY_PREFIX: "[Enhanced Version V2] "
        run: |
          PYTHONUNBUFFERED=1 python scanner_dual_tf_vp_spyder_telegram_loop_dip5.py

      - name: Stamp last run time (only if run succeeded)
        if: ${{ steps.gate.outputs.ok == 'yes' && success() }}
        run: |
          mkdir -p .cadence_cache
          date -u +%s > .cadence_cache/last_run_epoch.txt

      - name: Save cadence cache
        if: ${{ steps.gate.outputs.ok == 'yes' && success() }}
        uses: actions/cache/save@v4
        with:
          path: .cadence_cache
          key: cadence-${{ runner.os }}-v1-${{ github.run_id }}

      - name: Upload CSV + state as artifact
        if: ${{ steps.gate.outputs.ok == 'yes' || failure() }}
        uses: actions/upload-artifact@v4
        with:
          name: scanner-output
          path: |
            scanner_dual_tf_vp_dip4.csv
            .scanner_cache/alerts_dip4_seen.json

      - name: Save scanner cache
        if: ${{ steps.gate.outputs.ok == 'yes' && steps.scancache.outputs.cache-hit != 'true' }}
        uses: actions/cache/save@v4
        with:
          path: .scanner_cache
          key: scanner-cache-${{ runner.os }}-${{ env.WEEK_KEY }}
